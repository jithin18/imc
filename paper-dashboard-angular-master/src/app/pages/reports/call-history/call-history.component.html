

  <div class="row mb-3">
    <div class="col-12 d-flex align-items-center">
      <!-- Dropdown for Time Period Selection -->
      <label for="timePeriod" class="form-label me-2 mb-0">Select Period</label>
      <select id="timePeriod" class="form-select form-select-sm custom-dropdown" [(ngModel)]="selectedTimePeriod" (ngModelChange)="setDateRange()">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="last7days">Last 7 Days</option>
        <option value="last30days">Last 30 Days</option>
      </select>
      <button class="btn btn-sm ms-auto" 
        (click)="downloadCallDetails()" 
        [disabled]="loading"
        style=" margin-right: 55%;">
  {{ loading ? 'Downloading...' : 'Download Call Details' }}
</button>

    </div>
  </div>
  
  <style>
    .custom-dropdown {
      width: 150px; /* Adjust the width as necessary */
      max-width: 100%; /* Ensure it doesn't overflow the parent */
    }
  
    .form-label {
      font-size: 14px; /* Adjust label font size for better alignment */
    }
  
  </style>
  
  <div class="card-body">
    
  
    <!-- Table -->
    <div class="mat-elevation-z8 table-responsive">
      <table
        mat-table
        class="table table-striped table-report"
        [dataSource]="ongoingCalls"
        matSort
      >
        <!-- Call ID Column -->
        <ng-container matColumnDef="callId">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Call ID</th>
          <td mat-cell *matCellDef="let call">{{ call.callId }}</td>
        </ng-container>
    
        <!-- Caller Number Column -->
        <ng-container matColumnDef="callerNumber">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Caller Number</th>
          <td mat-cell *matCellDef="let call">{{ call.callerNumber }}</td>
        </ng-container>
    
        <!-- Call Date Column -->
        <ng-container matColumnDef="callDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
          <td mat-cell *matCellDef="let call">{{ call.callDate }}</td>
        </ng-container>
    
        <!-- Call Start Time Column -->
        <ng-container matColumnDef="callStartTime">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Call Start Time</th>
          <td mat-cell *matCellDef="let call">{{ call.callStartTime }}</td>
        </ng-container>
    
        <!-- Call End Time Column -->
        <ng-container matColumnDef="callEndTime">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Call End Time</th>
          <td mat-cell *matCellDef="let call">{{ call.callEndTime }}</td>
        </ng-container>
    
        <!-- Bot Chat Column -->
        <ng-container matColumnDef="botChat">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Bot Chat</th>
          <td mat-cell *matCellDef="let call">
            <ng-container *ngIf="call.botChat; else noChatTemplate">
              <button class="btn btn-sm btn-primary" (click)="openBotChat(call)">
                <i class="nc-icon nc-paper"></i>
              </button>
            </ng-container>
            <ng-template #noChatTemplate>No Chat</ng-template>
          </td>
        </ng-container>
    
        <!-- Call Recordings Column -->
        <ng-container matColumnDef="callRecordings">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Agent Chat</th>
          <td mat-cell *matCellDef="let call">
            <ng-container *ngIf="call.callRecordings !== 'No Voice'; else noVoiceTemplate">
              <audio controls>
                <source [src]="call.callRecordings" type="audio/wav" />
                Your browser does not support the audio element.
              </audio>
            </ng-container>
            <ng-template #noVoiceTemplate>No Voice</ng-template>
          </td>
        </ng-container>
    
        <!-- Table Header and Rows -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let call; columns: displayedColumns"></tr>
    
        <!-- No data row -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell table-message" colspan="7">
            No data Matching the Filter.
          </td>
        </tr>
      </table>
    
      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[5, 10, 20]"
        showFirstLastButtons
        [pageSize]="5">
      </mat-paginator>
    </div>
    
    
    
    
  

 
    <div class="modal" [class.show]="showModal" tabindex="-1" *ngIf="showModal">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title">Bot Chat</h5>
            
            <button
              type="button"
              class="btn-close"
              aria-label="Close"
              (click)="closeModal()"
            ></button>
          </div>
    
          <!-- Modal Body -->
          <div class="modal-body">
            <div class="chat-box" #chatBox>
              <div
                *ngFor="let chat of selectedBotChat"
                class="message"
                [ngClass]="{
                  'bot-message': chat.sender === 'Bot',
                  'customer-message': chat.sender === 'Customer'
                }"
              >
                <span *ngIf="chat.sender === 'Bot' && chat === selectedBotChat[0]">
                  {{ chat.message }}
                </span>
                <span *ngIf="chat.sender === 'Customer'">
                  {{ chat.message }}
                </span>
                <span *ngIf="chat.sender === 'Bot' && chat !== selectedBotChat[0]">
                  {{ chat.message }}
                </span>
              </div>
            </div>
          </div>
    
          <!-- Modal Footer for Total Sentiment -->
          <div class="modal-footer d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Total Sentiment: {{ totalSentiment }}%</h5>
           
            
          </div>
        </div>
      </div>
    </div>
    
  </div>
  
